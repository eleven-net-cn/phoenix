# Editor 编辑器功能需求文档

## 🎯 功能概述

Editor 是 Phoenix 低代码搭建系统的核心编辑器，提供可视化的页面搭建功能。用户可以通过拖拽组件的方式，在画布中构建页面，并通过右侧配置面板调整组件的各种属性。

## 🏗️ 整体架构

### 页面布局
```
┌─────────────────────────────────────────────────────────────────┐
│                            Header                               │
├─────────────┬─────────────────────────────┬─────────────────────┤
│             │                             │                     │
│   左侧面板    │          中间画布            │      右侧配置面板      │
│             │                             │                     │
│  - 组件库    │    - 页面预览区域            │   - 组件属性配置      │
│  - 页面树    │    - 拖拽编辑区域            │   - 样式配置         │
│  - 资源管理   │    - 组件选择区域            │   - 事件配置         │
│             │                             │                     │
├─────────────┴─────────────────────────────┴─────────────────────┤
│                            Footer                               │
└─────────────────────────────────────────────────────────────────┘
```

### 核心模块
1. **Header** - 顶部工具栏
2. **Left Panel** - 左侧面板（组件库、页面树）
3. **Canvas** - 中间画布（编辑区域）
4. **Inspector** - 右侧配置面板
5. **Toolbar** - 画布工具栏

## 📋 详细功能需求

### 1. Header 顶部工具栏

#### 1.1 基础信息展示
- **项目名称**: 显示当前编辑的项目名称
- **页面信息**: 显示当前编辑的页面名称和路径
- **保存状态**: 显示当前页面的保存状态（已保存/未保存）

#### 1.2 操作按钮
- **保存**: 保存当前页面配置
- **预览**: 在新窗口预览当前页面
- **发布**: 发布页面到指定环境
- **撤销/重做**: 操作历史记录
- **清空画布**: 清空当前画布内容

#### 1.3 视图模式切换
- **编辑模式**: 可拖拽编辑组件
- **预览模式**: 仅预览，不可编辑
- **代码模式**: 查看生成的代码

### 2. Left Panel 左侧面板

#### 2.1 组件库 (Component Library)
- **组件分类**: 按功能分类展示组件（容器、表单、展示、布局等）
- **组件搜索**: 支持按名称搜索组件
- **组件预览**: 鼠标悬停显示组件预览图
- **组件拖拽**: 支持拖拽组件到画布

#### 2.2 页面树 (Page Tree)
- **页面结构**: 以树形结构展示页面组件层级
- **组件选择**: 点击树节点选中对应组件
- **组件操作**: 右键菜单支持删除、复制、移动等操作
- **组件搜索**: 支持搜索页面中的组件

#### 2.3 资源管理 (Resource Manager)
- **图片资源**: 上传和管理图片资源
- **图标库**: 内置图标库选择
- **数据源**: 管理页面数据源配置

### 3. Canvas 中间画布

#### 3.1 画布容器
- **自适应尺寸**: 支持不同设备尺寸预览（桌面、平板、手机）
- **缩放控制**: 支持画布缩放（25% - 200%）
- **网格背景**: 可选的网格背景辅助对齐
- **标尺工具**: 水平和垂直标尺辅助定位

#### 3.2 组件布局系统
支持 4 种布局模式：

##### 3.2.1 文档流布局 (Flow)
- **默认布局**: 组件按文档流从上到下排列
- **块级元素**: 每个组件占据一行
- **内联元素**: 支持水平排列
- **间距控制**: 支持组件间间距设置

##### 3.2.2 绝对定位 (Position)
- **自由定位**: 组件可以自由拖拽到任意位置
- **坐标系统**: 基于父容器的坐标定位
- **层级控制**: 支持 z-index 层级设置
- **边界限制**: 限制组件在父容器内移动

##### 3.2.3 固定定位 (Fixed)
- **视口定位**: 组件相对于浏览器视口定位
- **滚动固定**: 页面滚动时组件保持固定位置
- **全屏覆盖**: 支持全屏覆盖层组件

##### 3.2.4 粘性定位 (Sticky)
- **滚动粘性**: 组件在滚动到指定位置时粘性定位
- **阈值设置**: 可设置粘性定位的触发阈值
- **容器限制**: 限制在指定容器内粘性定位

#### 3.3 组件交互
- **组件选择**: 点击选中组件，显示选择框
- **组件拖拽**: 拖拽移动组件位置
- **组件缩放**: 拖拽边框调整组件尺寸
- **组件旋转**: 支持组件旋转操作
- **组件对齐**: 智能对齐辅助线

#### 3.4 画布工具栏
- **选择工具**: 切换到选择模式
- **移动工具**: 切换到移动模式
- **缩放工具**: 切换到缩放模式
- **对齐工具**: 组件对齐功能
- **分布工具**: 组件分布功能
- **锁定工具**: 锁定/解锁组件

### 4. Inspector 右侧配置面板

#### 4.1 组件属性配置
- **基础属性**: 组件的基础配置项
- **样式属性**: 组件的样式配置
- **事件配置**: 组件的事件处理配置
- **数据绑定**: 组件的数据源配置

#### 4.2 动态表单渲染
- **表单生成**: 根据组件 Schema 动态生成配置表单
- **实时预览**: 配置修改时实时预览效果
- **验证规则**: 表单字段验证
- **默认值**: 支持设置默认值

#### 4.3 样式配置
- **布局样式**: 位置、尺寸、边距、内边距
- **外观样式**: 背景、边框、圆角、阴影
- **文字样式**: 字体、大小、颜色、对齐
- **动画样式**: 过渡、动画效果

#### 4.4 事件配置
- **点击事件**: 点击组件触发的事件
- **悬停事件**: 鼠标悬停触发的事件
- **表单事件**: 表单提交、验证等事件
- **自定义事件**: 支持自定义事件配置

### 5. 高级功能

#### 5.1 组件组合
- **组件组合**: 将多个组件组合成一个组件
- **组件解组**: 将组合组件拆分为独立组件
- **组件嵌套**: 支持组件的嵌套结构

#### 5.2 模板系统
- **页面模板**: 预定义的页面模板
- **组件模板**: 预定义的组件模板
- **模板保存**: 保存当前页面为模板
- **模板应用**: 应用模板到当前页面

#### 5.3 版本控制
- **操作历史**: 记录所有编辑操作
- **版本回退**: 支持回退到任意版本
- **版本对比**: 对比不同版本的差异
- **版本标签**: 为重要版本添加标签

#### 5.4 协作功能
- **实时协作**: 多人同时编辑
- **操作同步**: 实时同步其他用户的操作
- **冲突解决**: 处理编辑冲突
- **权限控制**: 不同用户的编辑权限

## 🎨 交互设计

### 1. 拖拽交互
- **拖拽预览**: 拖拽时显示组件预览
- **放置提示**: 显示可放置的区域
- **智能吸附**: 拖拽时智能吸附到网格或组件边缘
- **拖拽反馈**: 拖拽过程中的视觉反馈

### 2. 选择交互
- **单选**: 点击选择单个组件
- **多选**: Ctrl+点击选择多个组件
- **框选**: 拖拽框选多个组件
- **全选**: Ctrl+A 全选所有组件

### 3. 编辑交互
- **双击编辑**: 双击组件进入编辑模式
- **右键菜单**: 右键显示操作菜单
- **快捷键**: 支持常用操作的快捷键
- **撤销重做**: Ctrl+Z/Ctrl+Y 撤销重做

### 4. 键盘快捷键
- **Ctrl+Z**: 撤销操作
- **Ctrl+Y**: 重做操作
- **Ctrl+A**: 全选组件
- **Delete**: 删除选中组件
- **Ctrl+C**: 复制组件
- **Ctrl+V**: 粘贴组件
- **Ctrl+D**: 复制并粘贴组件
- **Esc**: 取消选择
- **Tab**: 在组件间切换选择
- **方向键**: 微调组件位置

### 5. 鼠标交互
- **左键点击**: 选择组件
- **左键拖拽**: 移动组件
- **右键点击**: 显示上下文菜单
- **滚轮**: 画布缩放
- **Ctrl+滚轮**: 画布缩放
- **Shift+拖拽**: 约束拖拽方向

## 🔧 技术架构

### 1. 整体架构设计

#### 1.1 分层架构
```
┌─────────────────────────────────────┐
│            Presentation Layer       │ ← UI 组件层
├─────────────────────────────────────┤
│            Business Logic Layer     │ ← 业务逻辑层
├─────────────────────────────────────┤
│            State Management Layer   │ ← 状态管理层
├─────────────────────────────────────┤
│            Data Layer               │ ← 数据层
└─────────────────────────────────────┘
```

#### 1.2 模块化设计
- **Editor Core**: 编辑器核心逻辑
- **Canvas Engine**: 画布渲染引擎
- **Component System**: 组件系统
- **Layout Engine**: 布局引擎
- **Event System**: 事件系统
- **Config System**: 配置系统

### 2. 核心技术栈

#### 2.1 前端框架
- **NextJS 15**: React 全栈框架
- **React 19**: UI 库，使用最新特性
- **TypeScript**: 类型安全的 JavaScript
- **UnoCSS**: 原子化 CSS 框架

#### 2.2 状态管理
- **Zustand**: 轻量级状态管理
- **Immer**: 不可变数据更新
- **React Query**: 服务端状态管理

#### 2.3 拖拽系统
- **@dnd-kit/core**: 核心拖拽功能
- **@dnd-kit/sortable**: 排序功能
- **@dnd-kit/modifiers**: 拖拽修饰器

#### 2.4 工具库
- **lodash-es**: 工具函数库
- **clsx**: 条件类名
- **date-fns**: 日期处理
- **zod**: 数据验证

### 3. 核心组件架构

#### 3.1 组件层次结构
```
Editor
├── Header
│   ├── ProjectInfo
│   ├── ActionButtons
│   └── ViewModeToggle
├── MainContent
│   ├── LeftPanel
│   │   ├── ComponentLibrary
│   │   ├── PageTree
│   │   └── ResourceManager
│   ├── Canvas
│   │   ├── CanvasContainer
│   │   ├── ComponentRenderer
│   │   ├── SelectionBox
│   │   └── CanvasToolbar
│   └── Inspector
│       ├── ComponentConfig
│       ├── StyleConfig
│       └── EventConfig
└── Footer
```

#### 3.2 核心组件设计

##### Canvas 组件
```typescript
interface CanvasProps {
  components: ComponentNode[];
  selectedIds: string[];
  layoutMode: LayoutMode;
  zoom: number;
  onComponentSelect: (id: string) => void;
  onComponentMove: (id: string, position: Position) => void;
  onComponentResize: (id: string, size: Size) => void;
}
```

##### ComponentRenderer 组件
```typescript
interface ComponentRendererProps {
  component: ComponentNode;
  isSelected: boolean;
  isDragging: boolean;
  onSelect: () => void;
  onMove: (position: Position) => void;
  onResize: (size: Size) => void;
}
```

##### Inspector 组件
```typescript
interface InspectorProps {
  selectedComponent: ComponentNode | null;
  onConfigChange: (config: ComponentConfig) => void;
  onStyleChange: (style: CSSProperties) => void;
  onEventChange: (events: EventConfig[]) => void;
}
```

### 4. 状态管理设计

#### 4.1 全局状态结构
```typescript
interface EditorState {
  // 项目信息
  project: {
    id: string;
    name: string;
    currentPage: string;
  };

  // 组件数据
  components: ComponentNode[];
  selectedIds: string[];

  // 画布状态
  canvas: {
    zoom: number;
    layoutMode: LayoutMode;
    gridEnabled: boolean;
    rulersEnabled: boolean;
  };

  // 编辑器状态
  editor: {
    mode: 'edit' | 'preview' | 'code';
    history: HistoryState;
    clipboard: ComponentNode[];
  };

  // UI 状态
  ui: {
    leftPanelWidth: number;
    rightPanelWidth: number;
    leftPanelTab: string;
    rightPanelTab: string;
  };
}
```

#### 4.2 状态更新流程
```
用户操作 → Action → Reducer → State 更新 → 组件重渲染 → UI 更新
```

### 5. 数据流设计

#### 5.1 单向数据流
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Action    │───▶│   Store     │───▶│   View      │
└─────────────┘    └─────────────┘    └─────────────┘
       ▲                   │                   │
       │                   ▼                   ▼
       └─────────────┐    ┌─────────────┐    ┌─────────────┐
                     │    │   State     │    │   Props     │
                     └────│   Update    │◀───│   Change    │
                          └─────────────┘    └─────────────┘
```

#### 5.2 组件通信
- **父子通信**: Props 传递
- **子父通信**: 回调函数
- **跨组件通信**: Zustand Store
- **全局事件**: Event Bus

### 6. 性能优化策略

#### 6.1 渲染优化
- **React.memo**: 组件记忆化
- **useMemo**: 计算结果缓存
- **useCallback**: 函数缓存
- **虚拟化**: 大量组件虚拟滚动

#### 6.2 状态优化
- **状态分片**: 按功能模块分片状态
- **选择性更新**: 只更新变化的状态
- **批量更新**: 批量处理状态更新
- **状态持久化**: 关键状态本地存储

#### 6.3 交互优化
- **防抖节流**: 拖拽和缩放操作
- **增量更新**: 只更新变化的组件
- **懒加载**: 组件和资源按需加载
- **预加载**: 预加载常用组件

### 7. 错误处理机制

#### 7.1 错误边界
- **组件错误**: React Error Boundary
- **渲染错误**: 降级渲染
- **配置错误**: 默认配置回退

#### 7.2 异常处理
- **拖拽异常**: 回滚到原始位置
- **配置异常**: 使用默认配置
- **网络异常**: 离线模式支持

### 8. 扩展性设计

#### 8.1 插件系统
- **组件插件**: 自定义组件注册
- **工具插件**: 自定义工具集成
- **主题插件**: 自定义主题支持

#### 8.2 配置化
- **组件配置**: JSON Schema 配置
- **布局配置**: 布局规则配置
- **主题配置**: 主题变量配置

## 📱 响应式设计

### 1. 设备适配
- **桌面端**: 1920px+ 大屏幕适配
- **平板端**: 768px-1024px 平板适配
- **手机端**: 320px-768px 手机适配

### 2. 布局适配
- **弹性布局**: 使用 Flexbox 和 Grid 布局
- **媒体查询**: 根据屏幕尺寸调整布局
- **组件适配**: 组件在不同设备上的表现

### 3. 交互适配
- **触摸支持**: 移动端触摸操作
- **手势识别**: 捏合缩放、滑动等手势
- **键盘适配**: 移动端虚拟键盘适配

## 🚀 性能优化

### 1. 渲染优化
- **虚拟滚动**: 大量组件时使用虚拟滚动
- **懒加载**: 组件按需加载
- **缓存机制**: 组件配置缓存

### 2. 交互优化
- **防抖节流**: 拖拽和缩放操作防抖
- **批量更新**: 批量处理组件更新
- **增量渲染**: 只渲染变化的组件

### 3. 内存优化
- **组件卸载**: 及时卸载不需要的组件
- **事件清理**: 清理事件监听器
- **定时器清理**: 清理定时器和动画

## 📋 开发计划

### Phase 1: 基础功能
- [ ] 画布容器搭建
- [ ] 基础组件拖拽
- [ ] 组件选择和高亮
- [ ] 基础属性配置

### Phase 2: 布局系统
- [ ] 文档流布局
- [ ] 绝对定位布局
- [ ] 固定定位布局
- [ ] 粘性定位布局

### Phase 3: 配置系统
- [ ] 动态表单渲染
- [ ] 样式配置面板
- [ ] 事件配置面板
- [ ] 数据绑定配置

### Phase 4: 高级功能
- [ ] 组件组合
- [ ] 模板系统
- [ ] 版本控制
- [ ] 协作功能

---

**文档版本**: v1.0
**最后更新**: 2024年12月
**维护者**: Eleven <master@eleven.net.cn>
